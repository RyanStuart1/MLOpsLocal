services:
  - type: web
    name: mlops-streamlit
    env: python
    plan: free
    buildCommand: pip install -U pip && pip install -r requirements.txt
    startCommand: streamlit run streamlit_app.py --server.port $PORT --server.address 0.0.0.0
    envVars:
      - key: API_BASE_URL
        fromService: { type: web, name: mlops-fastapi, property: host }
      - key: MLFLOW_TRACKING_URI
        fromService: { type: web, name: mlops-mlflow, property: host }

  - type: web
    name: mlops-fastapi
    env: python
    plan: free
    buildCommand: pip install -U pip && pip install -r requirements.txt
    startCommand: uvicorn api.main:app --host 0.0.0.0 --port $PORT
    envVars:
      - key: MLFLOW_TRACKING_URI
        fromService: { type: web, name: mlops-mlflow, property: host }

  - type: web
    name: mlops-mlflow
    env: python
    plan: free
    buildCommand: pip install -U pip && pip install mlflow gunicorn
    startCommand: >
      mlflow server
      --host 0.0.0.0
      --port $PORT
      --backend-store-uri sqlite:////tmp/mlflow.db
      --default-artifact-root /tmp/mlflow-artifacts
    # â¬† no "disk" section

  - type: worker
    name: mlops-prefect-worker
    env: python
    plan: free
    buildCommand: pip install -U pip && pip install -r requirements.txt
    startCommand: prefect worker start --pool default-agent-pool --limit 1
    envVars:
      - key: MLFLOW_TRACKING_URI
        fromService: { type: web, name: mlops-mlflow, property: host }
